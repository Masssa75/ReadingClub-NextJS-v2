module.exports=[16997,a=>{"use strict";var b,c=a.i(87924),d=a.i(72131),e=a.i(63851),f=a.i(62641),g=a.i(78530),h=((b={})[b.UNKNOWN=0]="UNKNOWN",b[b.SOMETIMES=1]="SOMETIMES",b[b.KNOWN=2]="KNOWN",b[b.MASTERED=3]="MASTERED",b),i=a.i(78625),j=a.i(8410);function k(a,b=[]){if(!a||0===a.length)return null;let c=a.filter(a=>!b.includes(a));return 0===c.length?a[Math.floor(Math.random()*a.length)]:c[Math.floor(Math.random()*c.length)]}let l=null,m=function(a,b,c){let d=b.toLowerCase();if(!c[d])return{score:0,predictedLetter:"?",targetScore:0};let e=a.map(a=>a.reduce((a,b)=>a+b,0)),g=a[e.indexOf(Math.max(...e))],h=Math.max(...g);h>0&&(g=g.map(a=>a/h));let i=null,j=0,k=0;return Object.keys(c).forEach(a=>{let b=function(a,b,c){if(!c[b]||!c[b].snapshots)return 0;let d=c[b].snapshots,e=0,g=null,h=0,i=null;if(d.forEach(b=>{if(!b||!b.data)return;let c=function(a,b){let c=0,d=Math.min(a.length,b.length);for(let e=0;e<d;e++)c+=Math.abs(a[e]-b[e]);return Math.max(0,100-c/d*100)}(a,b.data);b.isNegative?c>h&&(h=c,i=b):c>e&&(e=c,g=b)}),l={target:b,positiveSnapshot:g,positiveScore:e,negativeSnapshot:i,negativeScore:h,matchType:null},h>e+f.NEGATIVE_MARGIN){let a=h-e;return console.log(`‚ùå REJECTED: Negative (${h.toFixed(1)}%) beats positive (${e.toFixed(1)}%) by ${a.toFixed(1)}%`),l.matchType="rejected",0}if(h>0){let a=e-h;console.log(`‚úÖ ACCEPTED: Positive (${e.toFixed(1)}%) beats negative (${h.toFixed(1)}%) by ${a.toFixed(1)}%`)}else console.log(`‚úÖ ACCEPTED: Positive match (${e.toFixed(1)}%), no negatives`);return l.matchType="accepted",e}(g,a,c);b>j&&(j=b,i=a),a===d&&(k=b)}),{score:j,predictedLetter:i||"?",targetScore:k}},n={},o=new Set,p=null;function q(a,b){let c=`${a}_${b}`;o.add(c),n[c]&&clearTimeout(n[c]),n[c]=setTimeout(()=>{s(a,b),o.delete(c)},2e3)}async function r(a){let b=Array.from(o).map(a=>{let[b,...c]=a.split("_");return{letter:b,profileId:c.join("_")}});0!==b.length&&(console.log(`üîÑ Flushing ${b.length} pending score save(s)...`),Object.values(n).forEach(a=>clearTimeout(a)),n={},await Promise.all(b.map(({letter:b,profileId:c})=>s(b,c,a))),o.clear(),console.log("‚úÖ All pending scores flushed"))}async function s(a,b,c){let d=a.toLowerCase(),e=c||p;if(!e||!e[d]||!e[d].snapshots)return void console.warn(`‚ö†Ô∏è Cannot save scores: no calibration data for ${d}`);try{let a=e[d].snapshots.filter(a=>a.profileId===b);if(0===a.length)return;let{error:c}=await g.supabase.from("calibrations").update({pattern_data:{snapshots:a},updated_at:new Date().toISOString()}).eq("profile_id",b).ilike("letter",d);c?console.error(`‚ùå Error saving scores for ${d}:`,c):console.log(`üíæ Saved snapshot scores to Supabase: ${d} (${a.length} snapshots)`)}catch(a){console.error(`‚ùå Error in saveSnapshotScoresToSupabase:`,a)}}async function t(a,b){await r(b)}function u({currentLetter:a,calibrationData:b,currentPattern:e}){let f=(0,d.useRef)(null),g=(0,d.useRef)(null),h=(a,b)=>{let c=a.getContext("2d");if(!c)return;let d=a.width,e=a.height;if(c.fillStyle="rgba(0, 0, 0, 0.5)",c.fillRect(0,0,d,e),!b||0===b.length)return;let f=Math.max(...b);if(f<1)return;let g=b.map(a=>a/f),h=d/g.length;g.forEach((a,b)=>{let d=a*e,f=b/g.length*120+100;c.fillStyle=`hsl(${f}, 70%, 60%)`,c.fillRect(b*h,e-d,h-1,d)})};(0,d.useEffect)(()=>{if(!f.current||!a||!b)return;let c=f.current,d=c.getContext("2d");if(!d)return;c.width=c.offsetWidth||400,c.height=80;let e=b[a.toLowerCase()];if(!e||!e.snapshots||0===e.snapshots.length){d.fillStyle="rgba(0, 0, 0, 0.5)",d.fillRect(0,0,c.width,c.height);return}let g=e.snapshots.find(a=>!a.isNegative);if(!g||!g.data){d.fillStyle="rgba(0, 0, 0, 0.5)",d.fillRect(0,0,c.width,c.height);return}h(c,g.data)},[a,b]),(0,d.useEffect)(()=>{if(!g.current||!e)return;let a=g.current;a.getContext("2d")&&(a.width=a.offsetWidth||400,a.height=80,h(a,e))},[e]);let{positive:i,negative:j}=(()=>{if(!a||!b)return{positive:[],negative:[]};let c=b[a.toLowerCase()];return c&&c.snapshots?{positive:c.snapshots.filter(a=>!a.isNegative),negative:c.snapshots.filter(a=>a.isNegative)}:{positive:[],negative:[]}})();return(0,c.jsxs)("div",{className:"mt-5",children:[(0,c.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[(0,c.jsxs)("div",{className:"bg-black/30 p-4 rounded-[10px]",children:[(0,c.jsx)("div",{className:"text-[#aaa] text-[11px] mb-2 text-center",children:"üì¶ Stored Calibration"}),(0,c.jsx)("canvas",{ref:f,className:"w-full h-20 bg-black/30 rounded-[5px]"}),(0,c.jsx)("div",{className:"text-[#999] text-[10px] mt-1 text-center",children:(()=>{if(!a||!b)return"-";let c=b[a.toLowerCase()];if(!c||!c.snapshots)return"-";let d=c.snapshots.filter(a=>!a.isNegative).length,e=c.snapshots.filter(a=>a.isNegative).length;return e>0?`${d} positive, ${e} negative`:`${d} positive`})()})]}),(0,c.jsxs)("div",{className:"bg-black/30 p-4 rounded-[10px]",children:[(0,c.jsx)("div",{className:"text-[#aaa] text-[11px] mb-2 text-center",children:"üé§ Current Recording"}),(0,c.jsx)("canvas",{ref:g,className:"w-full h-20 bg-black/30 rounded-[5px]"})]})]}),(i.length>0||j.length>0)&&(0,c.jsxs)("div",{className:"mt-6",children:[(0,c.jsx)("div",{className:"text-[#ddd] text-sm font-bold mb-3",children:"Additional Training Patterns:"}),(0,c.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[i.map((a,b)=>(0,c.jsx)(v,{snapshot:a,index:b,isNegative:!1},`pos-${b}`)),j.map((a,b)=>(0,c.jsx)(v,{snapshot:a,index:b,isNegative:!0},`neg-${b}`))]})]})]})}function v({snapshot:a,index:b,isNegative:e}){let f=(0,d.useRef)(null);(0,d.useEffect)(()=>{if(!f.current||!a.data)return;let b=f.current,c=b.getContext("2d");if(!c)return;b.width=b.offsetWidth||300,b.height=60,c.fillStyle="rgba(0, 0, 0, 0.5)",c.fillRect(0,0,b.width,b.height);let d=Math.max(...a.data);if(d<1)return;let e=a.data.map(a=>a/d),g=b.width/e.length;e.forEach((a,d)=>{let f=a*b.height,h=d/e.length*120+100;c.fillStyle=`hsl(${h}, 70%, 60%)`,c.fillRect(d*g,b.height-f,g-1,f)})},[a.data]);let g=e?`‚úó NEGATIVE #${b+1}`:`‚úì POSITIVE #${b+1}`;return(0,c.jsxs)("div",{className:`${e?"border-red-600":"border-green-600"} ${e?"bg-red-900/10":"bg-green-900/10"} border-2 rounded-lg p-3`,children:[(0,c.jsx)("div",{className:`${e?"text-red-400":"text-green-400"} text-[11px] font-bold mb-1 text-center`,children:g}),(0,c.jsxs)("div",{className:"text-[#999] text-[10px] mb-2 text-center",children:["‚úì ",a.score||0," matches | Profile: ",a.profileId.substring(0,8)]}),(0,c.jsx)("canvas",{ref:f,className:"w-full h-[60px] bg-black/30 rounded"})]})}function w({volume:a,volumeThreshold:b,concentration:d,concentrationThreshold:e}){let f=2*b,g=Math.min(100,a/f*100),h=b/f*100,i=2*e,j=Math.min(100,d/i*100),k=e/i*100;return(0,c.jsxs)("div",{className:"my-5 p-4 bg-black/30 rounded-[10px]",children:[(0,c.jsx)("div",{className:"text-[#aaa] text-xs font-bold mb-3",children:"üé§ Voice Detection Thresholds"}),(0,c.jsxs)("div",{className:"mb-4",children:[(0,c.jsxs)("div",{className:"flex justify-between items-center mb-1",children:[(0,c.jsx)("span",{className:"text-[#ddd] text-[11px]",children:"Volume"}),(0,c.jsxs)("span",{className:"text-[#ddd] text-[11px]",children:[Math.round(a)," / ",b]})]}),(0,c.jsxs)("div",{className:"relative w-full h-5 bg-white/10 rounded-[10px] overflow-hidden",children:[(0,c.jsx)("div",{className:"h-full rounded-[10px]",style:{width:`${g}%`,background:a>=b?"#4CAF50":a>=.8*b?"#FDD835":"#f44336"}}),(0,c.jsx)("div",{className:"absolute top-0 h-full w-0.5 bg-[#FDD835]",style:{left:`${h}%`,boxShadow:"0 0 4px #FDD835"}})]})]}),(0,c.jsxs)("div",{children:[(0,c.jsxs)("div",{className:"flex justify-between items-center mb-1",children:[(0,c.jsx)("span",{className:"text-[#ddd] text-[11px]",children:"Energy Focus"}),(0,c.jsxs)("span",{className:"text-[#ddd] text-[11px]",children:[d.toFixed(1)," / ",e.toFixed(1)]})]}),(0,c.jsxs)("div",{className:"relative w-full h-5 bg-white/10 rounded-[10px] overflow-hidden",children:[(0,c.jsx)("div",{className:"h-full rounded-[10px]",style:{width:`${j}%`,background:d>=e?"#4CAF50":d>=.8*e?"#FDD835":"#f44336"}}),(0,c.jsx)("div",{className:"absolute top-0 h-full w-0.5 bg-[#FDD835]",style:{left:`${k}%`,boxShadow:"0 0 4px #FDD835"}})]})]})]})}var x=a.i(31626);function y({letter:a,onComplete:b}){let[e,f]=(0,d.useState)([]);return(0,d.useEffect)(()=>{let a=window.AudioContext||window.webkitAudioContext;if(a){let b=new a,c=b.createOscillator(),d=b.createGain();c.connect(d),d.connect(b.destination),c.frequency.setValueAtTime(523.25,b.currentTime),c.frequency.setValueAtTime(659.25,b.currentTime+.1),c.frequency.setValueAtTime(783.99,b.currentTime+.2),d.gain.setValueAtTime(.3,b.currentTime),d.gain.exponentialRampToValueAtTime(.01,b.currentTime+.4),c.start(b.currentTime),c.stop(b.currentTime+.4)}let c=["#FDD835","#7CB342","#00BCD4","#FF5722","#9C27B0"],d=[];for(let a=0;a<20;a++){let b=2*Math.PI*a/20,e=100+100*Math.random();d.push({id:a,x:0,y:0,vx:Math.cos(b)*e,vy:Math.sin(b)*e,color:c[Math.floor(Math.random()*c.length)],isCircle:Math.random()>.5})}f(d);let e=setTimeout(()=>{f([]),b&&b()},1e3);return()=>clearTimeout(e)},[a,b]),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(x.default,{id:"67ca15c62bb5403e",children:"@keyframes letterSuccess{0%{color:#fdd835;transform:scale(1)}20%{color:#7cb342;transform:scale(1.2)}40%{color:#00bcd4;transform:scale(1.3)}60%{color:#9c27b0;transform:scale(1.4)}to{color:#fdd835;transform:scale(1)}}.success-letter.jsx-67ca15c62bb5403e{animation:.8s ease-out letterSuccess}@keyframes confettiFall{0%{opacity:1}to{opacity:0}}.confetti-particle.jsx-67ca15c62bb5403e{animation:1s ease-out forwards confettiFall}"}),e.map(a=>(0,c.jsx)(z,{x:a.x,y:a.y,vx:a.vx,vy:a.vy,color:a.color,isCircle:a.isCircle},a.id))]})}function z({x:a,y:b,vx:e,vy:f,color:g,isCircle:h}){let[i,j]=(0,d.useState)({x:a,y:b,rotation:0,opacity:1});return(0,d.useEffect)(()=>{let a=Date.now(),b=()=>{let c=(Date.now()-a)/1e3;j({x:e*c,y:f*c+250*c*c,rotation:360*c,opacity:Math.max(0,1-1.5*c)}),c<1&&requestAnimationFrame(b)};requestAnimationFrame(b)},[e,f]),(0,c.jsx)("div",{className:"confetti-particle fixed pointer-events-none",style:{left:"50%",top:"50%",width:"10px",height:"10px",backgroundColor:g,borderRadius:h?"50%":"0",transform:`translate(${i.x}px, ${i.y}px) rotate(${i.rotation}deg)`,opacity:i.opacity,zIndex:9999}})}function A(){let{currentProfileId:a,isLoading:b}=(0,e.useProfileContext)(),{currentSession:n,recordAttempt:o,getSession:r}=function(a){let[b,c]=(0,d.useState)(null),e=(0,d.useRef)(null);(0,d.useEffect)(()=>{if(!a){c(null),e.current=null;return}let b=g(a);c(b),e.current=b},[a]);let g=(0,d.useCallback)(a=>{let b=new Date,c=`session_${a}`,d=localStorage.getItem(c);if(d)try{let c=JSON.parse(d),e=new Date(c.lastActivityTime),g=(b.getTime()-e.getTime())/1e3/60;if(g<f.SESSION_CONFIG.TIMEOUT_MINUTES){console.log(`üìù Resuming session from ${g.toFixed(1)} minutes ago`);let d=new Map(Object.entries(c.letterStats||{})),e={...c,startTime:new Date(c.startTime),lastActivityTime:b,letterStats:d};return h(e,a),e}console.log(`‚è∞ Session expired (${g.toFixed(1)} minutes old)`),Object.entries(c.letterStats||{})}catch(a){console.error("‚ùå Error parsing session data:",a)}let e={sessionId:`session_${Date.now()}`,profileId:a,startTime:b,lastActivityTime:b,attempts:[],letterStats:new Map,newLettersIntroduced:[],unknownLettersIntroduced:[],lettersGraduated:[],recentHistory:[]};return console.log("üÜï Created new session:",e.sessionId),h(e,a),e},[]),h=(0,d.useCallback)((a,b)=>{if(!a)return;let c=`session_${b}`,d={...a,letterStats:Object.fromEntries(a.letterStats)};localStorage.setItem(c,JSON.stringify(d))},[]),i=(0,d.useCallback)((b,d,g)=>{if(!e.current||!a)return void console.warn("‚ö†Ô∏è No active session");let i=e.current,j=new Date;i.lastActivityTime=j,i.attempts.push({letter:b,success:d,clickedListen:g,timestamp:j}),i.recentHistory.push(b),i.recentHistory.length>3&&i.recentHistory.shift();let k=i.letterStats.get(b);if(k||(k={attempts:[],listen_clicks:0,first_attempts_result:[],consecutive_success_no_listen:0,rapid_reps_remaining:0,state:"normal"},i.letterStats.set(b,k)),k.attempts.push(d),g&&(k.listen_clicks++,k.rapid_reps_remaining=f.SESSION_CONFIG.RAPID_REP_COUNT),k.first_attempts_result.length<f.SESSION_CONFIG.GRADUATION_TEST_ATTEMPTS&&k.first_attempts_result.push(d&&!g),d&&!g?k.consecutive_success_no_listen++:k.consecutive_success_no_listen=0,i.newLettersIntroduced.includes(b)&&!i.lettersGraduated.includes(b)&&k.consecutive_success_no_listen>=f.SESSION_CONFIG.GRADUATION_THRESHOLD){k.state="graduated_to_known",i.lettersGraduated.push(b),console.log(`üéì ${b} graduated to KNOWN!`);let a=i.unknownLettersIntroduced.indexOf(b);a>-1&&(i.unknownLettersIntroduced.splice(a,1),console.log(`‚ú® Freed up slot - can now introduce another UNKNOWN letter (${i.unknownLettersIntroduced.length}/${f.SESSION_CONFIG.MAX_NEW_LETTERS_PER_SESSION})`))}k.rapid_reps_remaining>0&&k.rapid_reps_remaining--,h(i,a),console.log(`üìù Recorded attempt: ${b} ${d?"‚úÖ":"‚ùå"} ${g?"üîä":""} (${k.consecutive_success_no_listen} streak)`),c({...i}),e.current=i},[a,h]);return{currentSession:b,recordAttempt:i,getSession:(0,d.useCallback)(()=>e.current,[]),endSession:(0,d.useCallback)(()=>{if(!e.current)return console.warn("‚ö†Ô∏è No active session to end"),null;let b=e.current;console.log("üèÅ Ending session:",b.sessionId),a&&localStorage.removeItem(`session_${a}`);let d=b.letterStats,f=b.lettersGraduated;return c(null),e.current=null,{letterStats:d,lettersGraduated:f,sessionId:b.sessionId}},[a])}}(a),{proficiencies:s}=function(a){let[b,c]=(0,d.useState)({}),[e,i]=(0,d.useState)(!1),j=(0,d.useCallback)(async()=>{if(a){i(!0);try{let{data:b,error:d}=await g.supabase.from("calibrations").select("letter, proficiency").eq("profile_id",a);if(d)throw d;let e={};b?.forEach(a=>{e[a.letter]=a.proficiency??h.UNKNOWN}),c(e),console.log("üìä Loaded proficiencies:",e)}catch(a){console.error("‚ùå Error loading proficiencies:",a)}finally{i(!1)}}},[a]);(0,d.useEffect)(()=>{j()},[j]);let k=(0,d.useCallback)(a=>b[a]??h.UNKNOWN,[b]),l=(0,d.useCallback)(async(b,d)=>{if(a)try{let{error:e}=await g.supabase.from("calibrations").update({proficiency:d}).eq("profile_id",a).eq("letter",b);if(e)throw e;c(a=>({...a,[b]:d})),console.log(`üìà Updated proficiency: ${b} ‚Üí ${d}`)}catch(a){console.error(`‚ùå Error updating proficiency for ${b}:`,a)}},[a]),m=(0,d.useCallback)(async(c,d)=>{if(!a)return;console.log("üîÑ Processing proficiency updates from session...");let e=[];for(let[a,g]of c.entries()){let c=b[a]??h.UNKNOWN,i=c;d.includes(a)&&(i=h.KNOWN,console.log(`üìà ${a}: UNKNOWN ‚Üí KNOWN`)),c===h.KNOWN&&g.first_attempts_result.slice(0,3).filter(a=>!0===a).length>=f.SESSION_CONFIG.GRADUATION_TEST_REQUIRED&&0===g.listen_clicks&&(i=h.MASTERED,console.log(`üåü ${a}: KNOWN ‚Üí MASTERED`)),c===h.MASTERED&&(g.listen_clicks>=f.SESSION_CONFIG.MASTERED_DEMOTION_LISTEN_CLICKS?(i=h.UNKNOWN,console.log(`üìâ ${a}: MASTERED ‚Üí UNKNOWN (${g.listen_clicks} LISTEN clicks)`)):1===g.listen_clicks&&(i=h.SOMETIMES,console.log(`üìâ ${a}: MASTERED ‚Üí SOMETIMES (1 LISTEN click)`))),c===h.KNOWN&&g.listen_clicks>=f.SESSION_CONFIG.KNOWN_DEMOTION_LISTEN_CLICKS&&(i=h.SOMETIMES,console.log(`üìâ ${a}: KNOWN ‚Üí SOMETIMES (${g.listen_clicks} LISTEN clicks)`)),i!==c&&e.push({letter:a,proficiency:i})}if(e.length>0){for(let a of(console.log(`üíæ Saving ${e.length} proficiency updates to Supabase...`),e))await l(a.letter,a.proficiency);console.log("‚úÖ Proficiency updates complete")}else console.log("‚ÑπÔ∏è No proficiency changes to save")},[a,b,l]),n=(0,d.useCallback)(a=>Object.entries(b).filter(([b,c])=>c===a).map(([a,b])=>a),[b]);return{proficiencies:b,loading:e,getProficiency:k,updateProficiency:l,updateProficienciesFromSession:m,getLettersByProficiency:n,reload:j}}(a),[v,x]=(0,d.useState)(!1),[z,A]=(0,d.useState)(null),[B,C]=(0,d.useState)("Click Start to begin"),[D,E]=(0,d.useState)(!1),[F,G]=(0,d.useState)(!1),[H,I]=(0,d.useState)(!1),[J,K]=(0,d.useState)(0),[L,M]=(0,d.useState)(0),[N,O]=(0,d.useState)(null),[P,Q]=(0,d.useState)(!1),[R,S]=(0,d.useState)(null),[T,U]=(0,d.useState)(""),[V,W]=(0,d.useState)({}),X=(0,d.useRef)(null),Y=(0,d.useRef)([]),Z=(0,d.useRef)(null),$=(0,d.useRef)(!1),_=(0,d.useRef)(null),aa=(0,d.useRef)(!1),ab=(0,d.useRef)(null);(0,d.useEffect)(()=>{a&&ac()},[a]);let ac=async()=>{if(a)try{let{data:a,error:b}=await g.supabase.from("calibrations").select("*");if(b)throw b;let c={};a?.forEach(a=>{let b=a.letter.toLowerCase();c[b]||(c[b]={snapshots:[]}),a.pattern_data?.snapshots&&c[b].snapshots.push(...a.pattern_data.snapshots)}),W(c),p=c,console.log("‚úÖ Loaded calibrations for",Object.keys(c).length,"letters:",Object.keys(c).join(", "))}catch(a){console.error("Error loading calibrations:",a)}},ad=async()=>{if(H)I(!1),E(!1),x(!0),aa.current=!0,ae(),af();else if(v)x(!1),aa.current=!1,C("Stopped"),A(null),I(!1),Z.current&&cancelAnimationFrame(Z.current),X.current&&((0,i.stopAudio)(X.current),X.current=null);else{if(0===Object.keys(V).length)return void alert("Please calibrate at least one letter first!");if(!X.current)try{X.current=await (0,i.setupAudio)()}catch(a){console.error("Failed to setup audio:",a),alert("Microphone access denied");return}x(!0),aa.current=!0,await ae(),af()}},ae=async()=>{let a=Object.keys(V);if(0===a.length)return void C("No calibrated letters");let b=r();if(!b){let b=a[Math.floor(Math.random()*a.length)];A(b),ab.current=b,await t(b,V),C(`Say: ${b}`),$.current=!1;return}let c=function(a,b,c){let d;if(!a)return console.error("‚ùå No active session for adaptive selection"),null;if(0===c.length)return console.warn("‚ö†Ô∏è No calibrated letters yet"),null;let e=(d={mastered:[],known:[],sometimes:[],unknown:[]},c.forEach(a=>{switch(b[a]??h.UNKNOWN){case h.MASTERED:d.mastered.push(a);break;case h.KNOWN:d.known.push(a);break;case h.SOMETIMES:d.sometimes.push(a);break;default:d.unknown.push(a)}}),d);console.log("üìä Pools:",{mastered:e.mastered.length,known:e.known.length,sometimes:e.sometimes.length,unknown:e.unknown.length});let g=a.attempts.length,i=a.recentHistory||[];if(g<f.SESSION_CONFIG.WARMUP_COUNT){let b,d;return console.log(`üî• Warmup phase (${g+1}/${f.SESSION_CONFIG.WARMUP_COUNT})`),(b=0===(d=[...e.mastered,...e.known]).length?k(c,i):e.mastered.length>0&&.67>Math.random()?k(e.mastered,i):k(d,i))&&!a.newLettersIntroduced.includes(b)&&(a.newLettersIntroduced.push(b),console.log(`üî• Warmup introduced: ${b}`)),b}if(a.attempts.length>0){for(let[b,c]of a.letterStats)if(c.rapid_reps_remaining>0){let a=f.SESSION_CONFIG.RAPID_REP_COUNT-c.rapid_reps_remaining+1;return console.log(`üîÅ Rapid reinforcement: ${b} (${a}/${f.SESSION_CONFIG.RAPID_REP_COUNT})`),b}}var j=e,l=a,m=i;let n=l.newLettersIntroduced.filter(a=>!l.lettersGraduated.includes(a));if(0===n.length){let a=function(a,b){let c=b.unknownLettersIntroduced?.length||0;if(c>=f.SESSION_CONFIG.MAX_NEW_LETTERS_PER_SESSION)return console.log(`‚ö†Ô∏è Max UNKNOWN letters (${f.SESSION_CONFIG.MAX_NEW_LETTERS_PER_SESSION}) reached this session`),null;let d=a.unknown.length>0?a.unknown:a.sometimes;if(0===d.length)return console.log("‚úÖ No new letters available - all letters practiced!"),null;let e=d.filter(a=>!b.newLettersIntroduced.includes(a));if(0===e.length)return null;let g=f.PHONEMES.map(a=>a.letter).find(a=>e.includes(a))||null;return g?(b.newLettersIntroduced.push(g),b.unknownLettersIntroduced||(b.unknownLettersIntroduced=[]),b.unknownLettersIntroduced.push(g),console.log(`üÜï Introduced new UNKNOWN letter: ${g} (${c+1}/${f.SESSION_CONFIG.MAX_NEW_LETTERS_PER_SESSION} unknown)`),g):null}(j,l);if(a)return a;let b=[...j.mastered,...j.known];return b.length>0?(console.log("üìö Reviewing comfortable letters (max new letters reached)"),k(b,m)):(console.warn("‚ö†Ô∏è No letters available for practice"),null)}if(Math.random()<f.SESSION_CONFIG.MIX_RATIO_PRACTICING)return k(n,m);{let a=[...j.mastered,...j.known];return 0===a.length?k(n,m):k(a,m)}}(b,s,a);c?(A(c),ab.current=c,await t(c,V),C(`Say: ${c}`),$.current=!1):(C("All letters mastered!"),x(!1),aa.current=!1)},af=()=>{let a=0,b=()=>{let c=X.current;if(!aa.current||!c||!c.analyser||!c.dataArray)return void console.log("‚ö†Ô∏è Detection loop stopped - isRunning:",aa.current,"audioState:",!!c);(0,j.getFrequencyData)(c.analyser,c.dataArray);let d=(0,j.calculateVolume)(c.dataArray),e=(0,j.downsampleTo64Bins)(c.dataArray),f=(0,j.calculateEnergyConcentration)(e);a%60==0&&console.log(`üé§ Voice detection active - Volume: ${d.toFixed(1)}, Concentration: ${f.toFixed(2)}`),a++,K(d),M(f),O(e),Y.current.push(e),Y.current.length>30&&Y.current.shift();let g=ab.current;if(g&&Y.current.length>=10){let b=(0,j.isNasal)(g)?3:12,c=(0,j.isNasal)(g)?1.2:2;d>b&&f>c?(console.log(`üéØ TRIGGERING MATCH CHECK - Letter: ${g}, Vol: ${d.toFixed(1)}, Conc: ${f.toFixed(1)}, Buffer: ${Y.current.length}`),ag()):(d>.5*b||f>.5*c)&&a%60==0&&console.log(`üîç Not matching - Letter: ${g}, Vol: ${d.toFixed(1)}/${b} (${d>b?"‚úì":"‚úó"}), Conc: ${f.toFixed(1)}/${c} (${f>c?"‚úì":"‚úó"})`)}else a%60==0&&console.log(`‚è∏Ô∏è Not checking - Letter: ${g||"null"}, Buffer length: ${Y.current.length}/10`);Z.current=requestAnimationFrame(b)};b()},ag=()=>{let a=ab.current;if(!a)return void console.log("‚ö†Ô∏è checkForMatch called but letter is null");let b=m(Y.current,a,V),c=l;console.log(`üîç Match check - predicted: ${b.predictedLetter}, target: ${a}, score: ${b.score}`),c&&"accepted"===c.matchType&&b.predictedLetter.toLowerCase()===a.toLowerCase()&&b.score>60?(console.log(`‚úÖ MATCH ACCEPTED! Calling handleSuccess`),ah(c.positiveSnapshot,c.positiveScore)):console.log(`‚ùå Match rejected - matchType: ${c?.matchType}, predicted: ${b.predictedLetter}, target: ${a}, score: ${b.score}`)},ah=async(a,b)=>{let c=ab.current;(console.log("üéâ handleSuccess ENTERED - letter from ref:",c),c)?(console.log("üéâ handleSuccess continuing - stopping voice detection"),x(!1),aa.current=!1,Z.current&&cancelAnimationFrame(Z.current),console.log("üéâ Setting showCelebration to TRUE"),E(!0),C(`‚úì Correct! You said '${c}'`),n&&o(c,!0,$.current),a&&function(a,b,c){let d=a.toLowerCase();if(!b||!c[d]||!c[d].snapshots)return console.log("‚ùå incrementSnapshotScore: Missing data",{letter:a,normalizedLetter:d,hasSnapshot:!!b,hasCalibrationData:!!c[d],hasSnapshots:!!c[d]?.snapshots,availableLetters:Object.keys(c).join(", ")});console.log("üîç incrementSnapshotScore called:",{letter:d,hasSnapshotData:!!b.data,snapshotDataLength:b.data?.length,snapshotProfileId:b.profileId?.substring(0,8),totalSnapshotsInMemory:c[d].snapshots.length});let e=c[d].snapshots.indexOf(b);if(-1===e&&(console.log("‚ö†Ô∏è Direct object reference failed, trying data comparison..."),e=c[d].snapshots.findIndex(a=>!!a.data&&!!b.data&&a.data.length===b.data.length&&a.data.slice(0,10).every((a,c)=>1e-4>Math.abs(a-b.data[c])))),-1!==e){let a=c[d].snapshots[e];a.score=(a.score||0)+1,console.log(`üìä Snapshot score incremented: ${d} [${a.isNegative?"NEG":"POS"}] ‚Üí ${a.score} (profile: ${a.profileId?.substring(0,8)}...)`),q(d,a.profileId)}else console.error(`‚ùå Could not find matching snapshot in calibrationData for ${d}`)}(c,a,V),ai(c),F?setTimeout(()=>{E(!1),x(!0),aa.current=!0,ae(),af()},2e3):I(!0)):console.log("‚ùå handleSuccess early return - letter is null")},ai=a=>{S(a),Q(!0),U(""),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{Q(!1),S(null)},5e3)};if((0,d.useEffect)(()=>()=>{Z.current&&cancelAnimationFrame(Z.current),X.current&&(0,i.stopAudio)(X.current),_.current&&clearTimeout(_.current)},[]),b)return(0,c.jsx)("div",{className:"text-center text-gray-400 mt-6",children:"Loading profile..."});if(!a)return(0,c.jsx)("div",{className:"text-center text-gray-400 mt-6",children:"No profile selected"});let aj=z&&(0,j.isNasal)(z)?3:12,ak=z&&(0,j.isNasal)(z)?1.2:2;return(0,c.jsxs)("div",{className:"mt-6 max-w-4xl mx-auto",children:[(0,c.jsxs)("div",{className:"flex justify-center items-center gap-4 mb-5 flex-wrap",children:[(0,c.jsxs)("label",{className:"text-[#ddd] text-sm cursor-pointer flex items-center gap-2",children:[(0,c.jsx)("span",{className:"opacity-80",children:"Auto-next:"}),(0,c.jsxs)("div",{className:"relative w-11 h-6 bg-white/20 rounded-full transition-colors",children:[(0,c.jsx)("input",{type:"checkbox",checked:F,onChange:a=>G(a.target.checked),className:"opacity-0 w-0 h-0 absolute"}),(0,c.jsx)("div",{className:"absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform",style:{transform:F?"translateX(20px)":"translateX(0)"}})]})]}),(0,c.jsx)("button",{onClick:ad,className:"px-6 py-2 bg-[#7CB342] text-white rounded-lg hover:bg-[#8BC34A] transition-colors",children:H?"‚ñ∂ Next Letter":v?"‚è∏ Stop Game":"‚ñ∂ Start Game"}),(0,c.jsx)("button",{onClick:()=>{v&&(ae(),Y.current=[])},className:"px-6 py-2 bg-[#999] text-white rounded-lg hover:bg-[#aaa] transition-colors",children:"Skip"}),z&&(0,c.jsx)("button",{onClick:()=>{if(!z)return;$.current=!0,console.log(`üîä LISTEN clicked for ${z}`);let a=f.PHONEMES.find(a=>a.letter===z);a?.audioUrl&&new Audio(a.audioUrl).play().catch(a=>console.error("Audio playback failed:",a))},className:"px-6 py-2 bg-[#1976D2] text-white rounded-lg hover:bg-[#2196F3] transition-colors",children:"üîä LISTEN"})]}),P&&R&&(0,c.jsxs)("div",{className:"text-center mb-5 p-4 bg-white/5 rounded-lg",children:[(0,c.jsx)("div",{className:"text-[#ddd] text-sm mb-2",children:"Recognition issue? Train the system:"}),(0,c.jsxs)("button",{onClick:()=>{R&&N&&a&&(U(function(a,b,c,d){let e=a.toLowerCase();if(!b||0===b.length)return console.error("Cannot add negative pattern: no current pattern"),{success:!1,message:"No current pattern to save"};if(!d[e])return console.error("Cannot add negative pattern: no calibration for letter",e),{success:!1,message:`No calibration found for letter ${e}`};let f={data:b,score:0,isNegative:!0,profileId:c,createdAt:new Date().toISOString()};d[e].snapshots||(d[e].snapshots=[]),d[e].snapshots.push(f);let g=d[e].snapshots.filter(a=>a.isNegative).length;return console.log(`‚úó Added negative pattern to ${e} (total: ${g})`),console.log("  Pattern preview:",b.slice(0,5)),q(e,c),{success:!0,message:`Added negative example for '${e}' (${g} total)`}}(R,N,a,V).message),Q(!1),S(null),_.current&&clearTimeout(_.current))},className:"px-6 py-2 bg-[#f44336] text-white rounded-lg hover:bg-[#ff5722] transition-colors",children:["‚úó Not '",R,"'"]}),T&&(0,c.jsx)("div",{className:"text-[#f44336] text-xs mt-2",children:T})]}),(0,c.jsxs)("div",{className:"text-center mb-5",children:[(0,c.jsx)("div",{className:"text-[#ddd] text-lg mb-2",children:"Say this sound:"}),(0,c.jsx)("div",{className:`text-[180px] font-bold text-[#FDD835] ${D?"success-letter":""}`,style:{textShadow:"0 10px 30px rgba(253, 216, 53, 0.5)"},children:z||"?"})]}),D&&z&&(0,c.jsx)(y,{letter:z,onComplete:()=>E(!1)}),(v||D)&&(0,c.jsx)(w,{volume:J,volumeThreshold:aj,concentration:L,concentrationThreshold:ak}),(v||D)&&(0,c.jsx)(u,{currentLetter:z,calibrationData:V,currentPattern:N}),(0,c.jsx)("div",{className:"text-center text-[#ddd] text-sm font-mono whitespace-pre-wrap mt-5",children:B})]})}a.s(["default",()=>A],16997)}];

//# sourceMappingURL=app_play_page_tsx_ddbd4f56._.js.map